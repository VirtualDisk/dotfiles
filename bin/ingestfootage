#!/usr/bin/env bash
set -euo pipefail

#TODO: only copy recent footage from sd card
#TODO: create premiere pro project, injest footage automatically
check_rsync() {
    echo "Checking if rsync is installed..."
    if [[ -f "/opt/homebrew/bin/rsync" ]]; then
        echo "rsync exists."
        main
    else
        install_rsync
    fi
}

install_rsync() { 
	if [[ -f "/opt/homebrew/bin/brew" ]]; then
		echo "Error! rsync not found. Install?"
		read yn
		case "${yn}" in

			Y | y | yes | Yes)
				brew install rsync
				main
				;;
			N | n | no | No)
				echo "Exiting."
				exit 0
				;;
			*)
				echo "Unknown option. Please enter y/n."
        esac
	else
		echo "Please install brew to run this bin."
	fi
}

set_vars()  {
    FOOTAGE_LOCATION="/Volumes/NO NAME/PRIVATE/M4ROOT/CLIP"
    PROJECT_FOLDER_LOCATION="${HOME}/Movies/"
    PROJECT_FOLDER_PREFIX="jump"
    PROJECT_FOLDER_NAME="${PROJECT_FOLDER_PREFIX}$(date -u +"%m%d")"
    PROJECT_TEMPLATE="${HOME}/Movies/template/template.prproj"
}

make_dir_then_copy()  {
    if [[ -d "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}" ]]; then
        #cp "${FOOTAGE_LOCATION}/*" "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}"
        rsync -r --info=progress2 "${FOOTAGE_LOCATION}" "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}"

    else
        mkdir -p "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}"
        #cp "${FOOTAGE_LOCATION}/*" "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}"
        rsync -r --info=progress2 "${FOOTAGE_LOCATION}" "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}"
    fi
}

create_proxies() {
    #TODO: use ffmpeg to create 480p proxies and append *_proxy to filenames
}


create_project() {
    cp "${PROJECT_TEMPLATE}" "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}/${PROJECT_FOLDER_NAME}.prproj"    
    chmod 770 "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}/${PROJECT_FOLDER_NAME}.prproj"    
    open "/Applications/Adobe Premiere Pro (Beta)/Adobe Premiere Pro (Beta).app" "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}/${PROJECT_FOLDER_NAME}.prproj"    
    open "${PROJECT_FOLDER_LOCATION}${PROJECT_FOLDER_NAME}"

}

debug() {
    echo "Folder location: ${PROJECT_FOLDER_LOCATION}"
    echo "Folder name: ${PROJECT_FOLDER_NAME}"
    echo "SD card location: ${FOOTAGE_LOCATION}"
}

main() {
    set_vars
    make_dir_then_copy
    create_proxies
    create_project
}
check_rsync
