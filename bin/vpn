#!/usr/bin/env bash

set -euo pipefail
# set -x
VPN_NAME="GH NY VPN"
WIFI_PRIMARY="Blancomesh"
WIFI_PRIMARY_SECRET="E1E2E3E4E5"
WIFI_SECONDARY="XFINITY"
main() {
    local status
    status="$(checkstatus)"
    case "${status}" in
        connected)
            disconnect
            statuswait "disconnected"
            echo "Disconnected from ${VPN_NAME}"
            # connect_wifi "${WIFI_PRIMARY}" "${WIFI_PRIMARY_SECRET}" 
            ;;
        disconnected)
            # connect_wifi "${WIFI_SECONDARY}"
            connect
            statuswait "connected"
            echo "Connected to ${VPN_NAME}"
            ;;
        *)
            echo "Unexpected status ${status}" >&2
            exit 1
            ;;
    esac
}

connect_wifi() {
    echo "Connecting to network ${1}..."
    networksetup -setairportnetwork en0 "${1}" "${2:-}" 
    sleep 5
}

checkstatus() {
    networksetup -showpppoestatus "${VPN_NAME}"
}

statuswait() {
    local desired_status status
    desired_status="${1}"
    status=""
    while [[ "${desired_status}" != "${status}"  ]]; do
        status="$(checkstatus)"
        echo "Waiting for VPN client... Answer the Duo push!"
        sleep 3
    done
}

connect() {
    echo "Connecting to ${VPN_NAME}..."
    networksetup -connectpppoeservice "${VPN_NAME}"
}

disconnect() {
    echo "Disconnecting from ${VPN_NAME}..."
    networksetup -disconnectpppoeservice "${VPN_NAME}"
}

main
